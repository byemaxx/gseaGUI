name: Publish to PyPI

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: false
        default: 'none'
        type: choice
        options:
          - 'none'
          - 'patch'
          - 'minor'
          - 'major'
      dry_run:
        description: 'Dry run (build only, do not publish)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    env:
      PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN || secrets.PYPI_TOKEN }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine==6.0.1
        
    - name: Update version if requested
      if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version_bump != 'none' }}
      run: |
        python -c "
        import re
        from pathlib import Path
        
        bump_type = '${{ github.event.inputs.version_bump }}'
        if bump_type not in {'major', 'minor', 'patch'}:
          raise SystemExit(f'Invalid bump type: {bump_type}')

        pyproject_path = Path('pyproject.toml')
        pyproject_text = pyproject_path.read_text(encoding='utf-8')

        # Find the [project] table and its version field
        project_match = re.search(r'(?ms)^\[project\]\s*$(.*?)(^\[|\Z)', pyproject_text)
        if not project_match:
          raise SystemExit('Could not find [project] table in pyproject.toml')
        project_block = project_match.group(1)

        version_match = re.search(r'(?m)^version\s*=\s*\"([^\"]+)\"\s*$', project_block)
        if not version_match:
          raise SystemExit('Could not find version = "..." under [project] in pyproject.toml')

        current_version = version_match.group(1)
        major, minor, patch = map(int, current_version.split('.'))
        
        if bump_type == 'major':
            major += 1
            minor = 0
            patch = 0
        elif bump_type == 'minor':
            minor += 1
            patch = 0
        elif bump_type == 'patch':
            patch += 1
        
        new_version = f'{major}.{minor}.{patch}'

        # Update pyproject.toml
        new_project_block = re.sub(
          r'(?m)^version\s*=\s*\"[^\"]+\"\s*$',
          f'version = \"{new_version}\"',
          project_block,
          count=1,
        )
        new_pyproject_text = pyproject_text[: project_match.start(1)] + new_project_block + pyproject_text[project_match.end(1) :]
        pyproject_path.write_text(new_pyproject_text, encoding='utf-8')

        print(f'Updated version from {current_version} to {new_version}')
        "
        
    - name: Show current version
      run: |
        python -c "
        import re
        from pathlib import Path

        pyproject = Path('pyproject.toml').read_text(encoding='utf-8')
        project_match = re.search(r'(?ms)^\[project\]\s*$(.*?)(^\[|\Z)', pyproject)
        project_block = project_match.group(1) if project_match else ''
        version_match = re.search(r'(?m)^version\s*=\s*\"([^\"]+)\"\s*$', project_block)
        print('pyproject.toml version:', version_match.group(1) if version_match else 'UNKNOWN')
        "
        
    - name: Build package
      run: |
        python -m build
        
    - name: Check package
      run: |
        twine check dist/*
        
    - name: List built files
      run: |
        echo "Built files:"
        ls -la dist/
        echo "Package contents:"
        python -c "
        import os
        for file in os.listdir('dist'):
            if file.endswith('.whl') or file.endswith('.tar.gz'):
                print(f'  - {file}')
        "
        
    - name: Debug workflow inputs
      run: |
        echo "Workflow inputs:"
        echo "  version_bump: ${{ github.event.inputs.version_bump }}"
        echo "  dry_run: ${{ github.event.inputs.dry_run }}"
        echo "Conditions:"
        echo "  version_bump != 'none': ${{ github.event.inputs.version_bump != 'none' }}"
        echo "  dry_run != 'true': ${{ github.event.inputs.dry_run != 'true' }}"
        
    - name: Commit version update
      if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version_bump != 'none' && github.event.inputs.dry_run != 'true' }}
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add pyproject.toml
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          VERSION=$(python -c "import re; from pathlib import Path; t=Path('pyproject.toml').read_text(encoding='utf-8'); m=re.search(r'(?ms)^\\[project\\]\\s*$(.*?)(^\\[|\\Z)', t); b=m.group(1) if m else ''; v=re.search(r'(?m)^version\\s*=\\s*\\\"([^\\\"]+)\\\"\\s*$', b); print(v.group(1) if v else '')")
          git commit -m "Bump version to $VERSION"
          git push
        fi
        
    - name: Create Git tag
      if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version_bump != 'none' && github.event.inputs.dry_run != 'true' }}
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        VERSION=$(python -c "import re; from pathlib import Path; t=Path('pyproject.toml').read_text(encoding='utf-8'); m=re.search(r'(?ms)^\\[project\\]\\s*$(.*?)(^\\[|\\Z)', t); b=m.group(1) if m else ''; v=re.search(r'(?m)^version\\s*=\\s*\\\"([^\\\"]+)\\\"\\s*$', b); print(v.group(1) if v else '')")
        echo "Creating tag for version: $VERSION"
        # Check if tag already exists
        if git rev-parse "v$VERSION" >/dev/null 2>&1; then
          echo "Tag v$VERSION already exists, skipping tag creation"
        else
          git tag -a "v$VERSION" -m "Release version $VERSION"
          git push origin "v$VERSION"
        fi
        
    - name: Check PyPI token
      if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run != 'true' && github.event.inputs.version_bump == 'none') }}
      run: |
        if [ -z "$PYPI_TOKEN" ]; then
          echo "‚ùå ERROR: Set secrets.PYPI_API_TOKEN (preferred) or secrets.PYPI_TOKEN"
          exit 1
        else
          echo "‚úÖ PyPI token is configured"
        fi
        
    - name: Publish to PyPI
      if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run != 'true' && github.event.inputs.version_bump == 'none') }}
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ env.PYPI_TOKEN }}
      run: |
        echo "Publishing to PyPI..."
        twine upload dist/* --verbose
        echo "‚úÖ Successfully published to PyPI"
        
    - name: Dry run summary
      if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true' }}
      run: |
        echo "üèÉ‚Äç‚ôÇÔ∏è DRY RUN COMPLETED"
        echo "‚úÖ Package built successfully"
        echo "‚úÖ Package validation passed"
        echo "‚ÑπÔ∏è  To publish for real, run this workflow again with 'Dry run' unchecked"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-files
        path: dist/
        retention-days: 30