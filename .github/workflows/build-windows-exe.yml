name: Build Windows EXE

on:
  workflow_dispatch:
    inputs:
      python_version:
        description: "Python version used for build"
        required: true
        # PyQt5 wheels对最新版本支持可能滞后，默认用更稳的 3.11（可在手动触发时改）。
        default: "3.11"
      create_release:
        description: "Create a GitHub Release and upload exe"
        required: true
        type: boolean
        default: false
      release_tag:
        description: "Release tag (e.g. v0.1.6). Required if create_release=true"
        required: false
        default: ""
      release_name:
        description: "Release title (optional)"
        required: false
        default: ""
      prerelease:
        description: "Mark release as prerelease"
        required: true
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show workspace files
        shell: pwsh
        run: |
          Write-Host "GITHUB_WORKSPACE=$env:GITHUB_WORKSPACE"
          Get-ChildItem -Force

      - name: Set up Conda
        uses: conda-incubator/setup-miniconda@v3
        with:
          # Mambaforge 已停止发布，latest 下载链接会 404；改用仍在维护的 Miniforge3。
          miniforge-variant: Miniforge3
          miniforge-version: latest
          activate-environment: gseagui
          python-version: ${{ inputs.python_version }}
          auto-activate-base: false

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          # Install project deps (from pyproject.toml) + PyInstaller
          python -m pip install .
          python -m pip install pyinstaller

      - name: Generate PyInstaller spec (runtime)
        shell: pwsh
        run: |
          $specPath = Join-Path $env:GITHUB_WORKSPACE 'gseagui-onefile.spec'
          $specContent = @'
# -*- mode: python ; coding: utf-8 -*-

from __future__ import annotations

import os
from pathlib import Path

from PyInstaller.utils.hooks import collect_submodules, collect_data_files

block_cipher = None

# 不依赖 __file__：某些 PyInstaller 版本执行 spec 时不会定义它
PROJECT_ROOT = Path(globals().get("SPECPATH", os.getcwd())).resolve()
PACKAGE_DIR = PROJECT_ROOT / "gseagui"
ENTRY_SCRIPT = PACKAGE_DIR / "main.py"

hiddenimports = []
hiddenimports += collect_submodules("gseagui")
# gseapy / matplotlib 有不少动态导入；显式收集可减少运行时报错。
hiddenimports += collect_submodules("gseapy")
hiddenimports += collect_submodules("matplotlib")

# 目前 gseagui/assets 为空；保留规则，未来加图标/资源时无需改 spec。
datas = []
datas += collect_data_files("gseagui", includes=["assets/**/*"], include_py_files=False)

from PyInstaller.building.build_main import Analysis, PYZ, EXE

a = Analysis(
    [str(ENTRY_SCRIPT)],
    pathex=[str(PROJECT_ROOT)],
    binaries=[],
    datas=datas,
    hiddenimports=hiddenimports,
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=block_cipher,
    noarchive=False,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

exe = EXE(
    pyz,
    a.scripts,
    a.binaries,
    a.zipfiles,
    a.datas,
    [],
    name="gseagui",
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=True,
    upx_exclude=[],
    runtime_tmpdir=None,
    console=False,
)
  '@

        $specContent | Set-Content -Path $specPath -Encoding UTF8

          if (!(Test-Path $specPath)) { throw "Failed to create spec file at: $specPath" }
          Write-Host "Created spec: $specPath"

      - name: Build onefile exe
        shell: pwsh
        run: |
          $spec = Join-Path $env:GITHUB_WORKSPACE 'gseagui-onefile.spec'
          if (!(Test-Path $spec)) { throw "Spec file not found: $spec" }

          python -m PyInstaller -y --clean $spec
          if ($LASTEXITCODE -ne 0) { throw "PyInstaller failed with exit code $LASTEXITCODE" }

          if (!(Test-Path "dist/gseagui.exe")) { throw "dist/gseagui.exe not found" }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gseagui-windows-exe
          path: dist/gseagui.exe
          if-no-files-found: error

      - name: Validate release inputs
        if: ${{ inputs.create_release }}
        shell: pwsh
        run: |
          if ([string]::IsNullOrWhiteSpace("${{ inputs.release_tag }}")) {
            throw "release_tag is required when create_release=true"
          }

      - name: Create GitHub Release
        if: ${{ inputs.create_release }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag }}
          name: ${{ inputs.release_name != '' && inputs.release_name || inputs.release_tag }}
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          files: |
            dist/gseagui.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
